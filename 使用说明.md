# 统一OOD检测框架使用说明

## 概述

本框架整合了W-DOE和DAL两种OOD检测方法，提供统一的训练和测试接口。支持CIFAR-10/100作为ID数据集，多种辅助OOD数据集，以及标准的OOD测试基准。

## 基本使用

### 训练命令

```bash
# W-DOE训练
python unified_main.py --method wdoe --dataset cifar10 --epochs 10 --gamma 0.5

# DAL训练  
python unified_main.py --method dal --dataset cifar100 --epochs 50 --gamma 10.0

# 对比两种方法
python unified_main.py --method both --dataset cifar10
```

### 测试模式

```bash
# 仅测试，不训练
python unified_main.py --method wdoe --dataset cifar10 --test

# 测试预训练模型
python unified_main.py --method dal --dataset cifar100 --test --load_checkpoint path/to/model.pt
```

## 超参数配置

### 配置方式

框架支持三种配置超参数的方式：

1. **命令行参数** (最高优先级)
2. **配置文件**
3. **默认配置类**

### 配置优先级规则

```
命令行参数 > 配置文件 > 默认配置类 > 基础配置
```

### W-DOE 超参数

| 参数名 | 默认值 | 说明 | 命令行示例 |
|--------|--------|------|------------|
| `gamma` | 0.5 | AWP正则化强度 | `--gamma 0.8` |
| `warmup` | 5 | 预热训练轮数 | `--warmup 10` |
| `epochs` | 10 | 总训练轮数 | `--epochs 20` |
| `learning_rate` | 0.01 | 学习率 | `--learning_rate 0.02` |
| `auxiliary_data` | 'tinyimagenet200' | 辅助OOD数据集 | `--auxiliary_data tinyimagenet200` |

### DAL 超参数

| 参数名 | 默认值 | 说明 | 命令行示例 |
|--------|--------|------|------------|
| `gamma` | 10.0 | 分布正则化强度 | `--gamma 15.0` |
| `beta` | 0.01 | 自适应调整率 | `--beta 0.005` |
| `rho` | 10.0 | 目标正则化水平 | `--rho 12.0` |
| `strength` | 1.0 | 扰动步长 | `--strength 1.5` |
| `iter` | 10 | 内部迭代步数 | `--iter 15` |
| `epochs` | 50 | 总训练轮数 | `--epochs 100` |
| `learning_rate` | 0.07 | 学习率 | `--learning_rate 0.1` |
| `auxiliary_data` | '80m_tinyimages' | 辅助OOD数据集 | `--auxiliary_data 80m_tinyimages` |

### 通用超参数

| 参数名 | 默认值 | 说明 | 命令行示例 |
|--------|--------|------|------------|
| `dataset` | 'cifar10' | ID数据集 | `--dataset cifar100` |
| `batch_size` | 128 | 训练批次大小 | `--batch_size 256` |
| `test_bs` | 200 | 测试批次大小 | `--test_bs 100` |
| `prefetch` | 4 | 数据加载进程数 | `--prefetch 8` |
| `depth` | 40 | WideResNet深度 | `--depth 28` |
| `widen_factor` | 2 | WideResNet宽度因子 | `--widen_factor 4` |
| `droprate` | 0.3 | Dropout率 | `--droprate 0.5` |

### 自定义配置文件

创建 `custom_config.yaml`：

```yaml
# W-DOE配置
wdoe:
  gamma: 0.8
  warmup: 8
  epochs: 15
  learning_rate: 0.015

# DAL配置  
dal:
  gamma: 12.0
  beta: 0.008
  rho: 15.0
  epochs: 60

# 通用配置
common:
  batch_size: 256
  dataset: cifar100
```

使用配置文件：
```bash
python unified_main.py --config custom_config.yaml --method wdoe
```

## 输出格式和保存位置

### 默认输出目录结构

```
outputs/
├── checkpoints/          # 模型检查点
│   ├── wdoe/
│   │   └── cifar10_epoch_10.pt
│   └── dal/  
│       └── cifar100_epoch_50.pt
├── logs/                 # 训练日志
│   ├── wdoe_cifar10_20241201_143022.log
│   └── dal_cifar100_20241201_143022.log
├── results/              # 实验结果
│   ├── wdoe_cifar10_results.json
│   └── dal_cifar100_results.json
└── comparisons/          # 方法对比结果
    └── wdoe_vs_dal_cifar10_20241201.json
```

### 输出格式规范

#### 训练日志格式
```
[2024-12-01 14:30:22] INFO - Epoch: 1/10
[2024-12-01 14:30:25] INFO - Train Loss: 2.3456, Train Acc: 0.6789
[2024-12-01 14:30:27] INFO - Test OOD Detection - AUROC: 0.8234, AUPR: 0.7891, FPR95: 0.2345
```

#### 结果JSON格式
```json
{
  "method": "wdoe",
  "dataset": "cifar10", 
  "config": {
    "gamma": 0.5,
    "warmup": 5,
    "epochs": 10
  },
  "final_results": {
    "train_acc": 0.9456,
    "test_acc": 0.9234,
    "ood_detection": {
      "dtd": {"auroc": 0.8234, "aupr": 0.7891, "fpr95": 0.2345},
      "svhn": {"auroc": 0.8456, "aupr": 0.8012, "fpr95": 0.2123},
      "isun": {"auroc": 0.8678, "aupr": 0.8234, "fpr95": 0.1987}
    }
  },
  "training_time": "00:45:23",
  "timestamp": "2024-12-01T14:30:22"
}
```

### 自定义输出位置

#### 通过命令行参数
```bash
# 自定义输出根目录
python unified_main.py --method wdoe --dataset cifar10 --output_dir /path/to/custom/output

# 自定义检查点保存路径
python unified_main.py --method wdoe --dataset cifar10 --checkpoint_dir /path/to/checkpoints

# 自定义日志保存路径  
python unified_main.py --method wdoe --dataset cifar10 --log_dir /path/to/logs
```

#### 通过环境变量
```bash
export OOD_OUTPUT_DIR="/path/to/output"
export OOD_CHECKPOINT_DIR="/path/to/checkpoints" 
export OOD_LOG_DIR="/path/to/logs"

python unified_main.py --method wdoe --dataset cifar10
```

#### 通过配置文件
```yaml
paths:
  output_dir: "/path/to/output"
  checkpoint_dir: "/path/to/checkpoints"
  log_dir: "/path/to/logs"
  result_dir: "/path/to/results"
```

## 数据集配置规范

### ID数据集 (CIFAR-10/100)

框架自动下载和处理CIFAR数据集，无需手动配置。

**存储位置**: `~/.cache/pytorch/datasets/` (PyTorch默认)

**支持的数据集**:
- `cifar10`: CIFAR-10 (10类，32x32彩色图像)
- `cifar100`: CIFAR-100 (100类，32x32彩色图像)

### 辅助OOD数据集

#### TinyImageNet-200 (W-DOE使用)

**预期路径**: `../data/tiny-imagenet-200/train/`

**目录结构**:
```
../data/
└── tiny-imagenet-200/
    ├── train/
    │   ├── n01443537/
    │   ├── n01629819/
    │   └── ... (200个类别文件夹)
    ├── val/
    └── test/
```

**获取方式**: 
```bash
cd ../data
wget http://cs231n.stanford.edu/tiny-imagenet-200.zip
unzip tiny-imagenet-200.zip
```

#### 80 Million Tiny Images (DAL使用)

**预期路径**: `../data/tiny_images.bin`

**配置文件**: `utils/80mn_cifar_idxs.txt` (CIFAR重叠图片索引)

**文件大小**: ~37GB

**获取说明**: 由于版权原因，需要从官方渠道获取

### 测试OOD数据集

#### Describable Textures Dataset (DTD)
- **路径**: `../data/dtd/images/`
- **下载**: https://www.robots.ox.ac.uk/~vgg/data/dtd/

#### SVHN
- **路径**: 自动下载到 `~/.cache/pytorch/datasets/`
- **框架**: 使用PyTorch内置下载

#### iSUN  
- **路径**: `../data/iSUN/`
- **说明**: 从SUN数据集中随机采样的子集

#### Places365 (仅DAL使用)
- **路径**: `../data/places365_standard/`
- **下载**: http://places2.csail.mit.edu/

#### LSUN (仅DAL使用)
- **路径**: `../data/LSUN/` 和 `../data/LSUN_resize/`
- **说明**: 包含多个场景类别

### 数据集路径配置

#### 通过命令行指定
```bash
python unified_main.py --method wdoe --dataset cifar10 \
  --data_root ../data \
  --tiny_imagenet_path ../data/tiny-imagenet-200 \
  --dtd_path ../data/dtd/images
```

#### 通过环境变量
```bash
export DATA_ROOT="../data"
export TINY_IMAGENET_PATH="../data/tiny-imagenet-200"
export DTD_PATH="../data/dtd/images"
export ISUN_PATH="../data/iSUN"
```

#### 通过配置文件
```yaml
data_paths:
  data_root: "../data"
  tiny_imagenet: "../data/tiny-imagenet-200"
  tiny_images_80m: "../data/tiny_images.bin"
  dtd: "../data/dtd/images"
  places365: "../data/places365_standard"
  lsun: "../data/LSUN"
  lsun_resize: "../data/LSUN_resize"
  isun: "../data/iSUN"
```

### 数据集验证

框架提供数据集完整性检查：

```bash
# 检查所有数据集
python unified_main.py --check_datasets

# 检查特定方法需要的数据集
python unified_main.py --method wdoe --check_datasets
python unified_main.py --method dal --check_datasets

# 检查特定数据集
python unified_main.py --check_dataset dtd
python unified_main.py --check_dataset tiny_imagenet
```

## 最佳实践建议

### 实验管理
1. 使用有意义的实验名称: `--exp_name wdoe_gamma0.8_cifar10`
2. 保存重要实验的配置文件
3. 定期备份重要的检查点

### 性能优化
1. 根据GPU内存调整batch_size
2. 使用多进程数据加载: `--prefetch 8`
3. 对于大数据集，考虑使用数据并行

### 调试和监控
1. 使用 `--debug` 模式获得详细日志
2. 设置 `--save_freq` 控制检查点保存频率
3. 使用 `--early_stop` 避免过拟合

## 常见问题

### Q: 数据集下载失败怎么办？
A: 
1. 检查网络连接
2. 手动下载并放置到指定路径
3. 使用 `--check_datasets` 验证数据集完整性

### Q: 如何在多GPU上训练？
A: 
```bash
python unified_main.py --method wdoe --dataset cifar10 --gpu_ids 0,1,2,3
```

### Q: 如何恢复中断的训练？
A: 
```bash
python unified_main.py --method wdoe --dataset cifar10 --resume path/to/checkpoint.pt
```

### Q: 如何修改评估指标？
A: 在配置文件中指定：
```yaml
evaluation:
  metrics: ["auroc", "aupr", "fpr95", "accuracy"]
  save_scores: true
```